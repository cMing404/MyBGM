function MusicVisualizer(a){this.buffer={};this.source=null;this.audio=new Audio();this.audio.crossOrigin="anonymous";this.audioSource=MusicVisualizer.ac.createMediaElementSource(this.audio);this.count=0;this.onended=a.onended;this.size=a.size||32;this.visualizer=a.visualizer;this.initCallback=null;this.gainNode=MusicVisualizer.ac[MusicVisualizer.ac.createGain?"createGain":"createGainNode"]();this.analyser=MusicVisualizer.ac.createAnalyser();this.delayNode=MusicVisualizer.ac.createDelay(179);typeof a.delay==="number"&&(this.delayNode.delayTime.value=a.delay);this.analyser.connect(this.delayNode);this.delayNode.connect(this.gainNode);this.gainNode.connect(MusicVisualizer.ac.destination);this.xhr=new window.XMLHttpRequest();MusicVisualizer.visualize(this)}MusicVisualizer.ac=new (window.AudioContext||window.webkitAudioContext||window.mozAudioContext)();MusicVisualizer.isFunction=function(a){return Object.prototype.toString.call(a)=="[object Function]"};MusicVisualizer.load=function(c,b,a){c.abort();c.open("GET",b,true);c.responseType="arraybuffer";c.onload=function(){MusicVisualizer.isFunction(a)&&a.call(c.response)};c.send()};MusicVisualizer.play=function(a){a.source.connect(a.analyser);if(a.source===a.audioSource){a.audio.play();a.audio.onended=a.onended}else{a.source[a.source.start?"start":"noteOn"](0);MusicVisualizer.isFunction(a.onended)&&(a.source.onended=a.onended)}};MusicVisualizer.stop=function(a){if(a.source===a.audioSource){a.audio.pause();a.audio.onended=window.undefined}else{a.source[a.source.stop?"stop":"noteOff"](0);a.source.onended=window.undefined}};MusicVisualizer.visualize=function(b){b.analyser.fftSize=b.size*2;var a=new Uint8Array(b.analyser.frequencyBinCount);var e=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.mzRequestAnimationFrame;var d=0;function c(){b.analyser.getByteFrequencyData(a);var g=Math.round(100*Array.prototype.reduce.call(a,function(h,i){return h+i})/b.size/256);var f=g-d;d=g;b.visualizer.call(a,f,g);e(c)}MusicVisualizer.isFunction(b.visualizer)&&e(c)};MusicVisualizer.prototype.decode=function(c,a){var b=this;MusicVisualizer.ac.decodeAudioData(c,function(d){var e=MusicVisualizer.ac.createBufferSource();e.buffer=d;a.call(e)},function(d){console.log(d)})};MusicVisualizer.prototype.play=function(e,a){var b=this;var c=++b.count;b.source&&MusicVisualizer.stop(b);if(e instanceof ArrayBuffer){b.decode(e,function(){b.initCallback&&!b.source&&MusicVisualizer.isFunction(b.initCallback)&&b.initCallback();b.source=this;MusicVisualizer.play(b)})}if(typeof(e)==="string"){if(!a){b.audio=new Audio(e);b.audio.crossOrigin="anonymous";b.audioSource=MusicVisualizer.ac.createMediaElementSource(b.audio);b.initCallback&&!b.source&&MusicVisualizer.isFunction(b.initCallback)&&b.initCallback();b.source=b.audioSource;MusicVisualizer.play(b);return}if(e in b.buffer){MusicVisualizer.stop(b.source);var d=MusicVisualizer.ac.createBufferSource();d.buffer=b.buffer[e];b.source=d;MusicVisualizer.play(b)}else{MusicVisualizer.load(b.xhr,e,function(){if(c!=b.count){return}b.decode(this,function(){if(c!=b.count){return}b.initCallback&&!b.source&&MusicVisualizer.isFunction(b.initCallback)&&b.initCallback();b.source=this;MusicVisualizer.play(b)})})}}};MusicVisualizer.prototype.start=function(){if(this.source===this.audioSource){this.audio.play()}else{this.source&&this.source[this.source.start?"start":"noteOn"](0)}};MusicVisualizer.prototype.addinit=function(a){this.initCallback=a};MusicVisualizer.prototype.changeVolume=function(a){this.gainNode.gain.value=a*a};