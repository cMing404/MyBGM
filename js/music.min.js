var SIZE=128;var rang=SIZE;var Music=(function(){function a(b,d){this.currentSong=0;this.list=$("#m-list");this.listBtn=$("#m-box h3");this.lyricContainer=$(".lyc-container");this.rateBar=$("#timeProgress .progress-bar");this.rate=$("#timeProgress");this.volBar=$("#vol .progress-bar");this.vol=$("#vol .progress");this.f_play=$("#f-play");this.f_prev=$("#f-prev");this.f_next=$("#f-next");this.spe=$(".spe>img");this.spePre={};this.randomImg={};this.theme={};this.lyric=[];this.PLAY=1;this.PAUSE=-1;this.STOP=0;this.audio=null;var c=this;this.visualizer=new MusicVisualizer({size:SIZE,onended:function(){c.playTo("next")},visualizer:Render()});var e=this.getTheme();if(e){this.theme.type=e[2];this.theme.count=e[4]}else{this.theme.type="mayday";this.theme.count=20}this.initList();this.listBtn.click(function(){$(this).next().toggle()});this.list.on("click","li",function(){c.currentSong=parseInt($(this).data("idx"));c.playNew(c.currentSong)});$(document).on("click",function(f){f.target.nodeName!=="H3"&&c.list.hide()});this.f_play.click(function(){if(c.status===c.PLAY){c.status=c.PAUSE}else{c.status=c.PLAY}c.upState()});this.f_next.click(function(){c.playTo("next")});this.f_prev.click(function(){c.playTo("prev")});this.rate.click(function(g){var f=g.offsetX/c.rate.width();c.audio.currentTime=f*c.audio.duration});this.vol.click(function(h){var f=c.vol.width();var g=h.offsetX/f;c.audio.volume=g;c.volBar.width(g*f)})}a.prototype.initList=function(){var b=this;$.ajax({type:"GET",url:"data/"+this.theme.type+".php",dataType:"json",success:function(f){b.allSongData=f;var e="";var c=Array.prototype.slice.apply(b.allSongData);for(var d=0;d<c.length;d++){e+="\n                    <li data-idx='"+d+'\'><a href="#"><i>'+(d+1)+"</i><span>"+c[d].song_name+"-"+c[d].artist+"</span></a></li>\n                  "}b.list.html(e);b.listLi=$("#m-list li");b.playTo()}})};a.prototype.playTo=function(b){var c=0;this.listLi.each(function(d,e){if(e.className==="current"){c=d;return false}});if(b){switch(b){case"prev":if(c===0){c=this.allSongData.length-1}else{c--}break;case"next":if(c===this.allSongData.length-1){c=0}else{c++}break}}this.playNew(this.currentSong=c)};a.prototype.playNew=function(c){this.lyricContainer.html("<div>正在载入...</div>");this.spePre.moved=0;this.lyric=null;clearInterval(this.randomImg.timer);this.randomImg.timer=null;clearInterval(this.spePre.timer);this.spe.attr("src","images/special/"+this.theme.type+"/"+this.allSongData[this.currentSong].spe_en+".jpg");var d=this;this.visualizer.play(this.allSongData[c].qiniu_src,false);this.audio=this.visualizer.audio;this.audio.addEventListener("timeupdate",function(){if(d.lyricContainer.children().length===0){return}var f=this.currentTime;var j=this.duration;var e=0,q=0,r=0,g=0;var h=0;var t=d.rateBar.parent().width();d.rateBar.width(f*t/j);if(!d.lyric){return}for(var m=0,k=d.lyric.length;m<k;m++){if(f>d.lyric[m][0]-0.5){var u=document.querySelectorAll('[data-line="'+m+'"]')[0];var s=document.querySelectorAll('[data-line="'+m+'"]')[1];var p=u.previousElementSibling;var o=s.previousElementSibling;if(p){p.className=""}if(o){o.className=""}u.className="active";s.className="active";d.lyricContainer.children().css("top",130-u.offsetTop+"px");d.lyricContainer.children().css("top",130-s.offsetTop+"px")}}});this.audio.onended=function(){d.playTo("next")};var b="./data/"+this.theme.type+"/"+this.allSongData[c].lrc_name+".lrc";d.getLyric(b);d.status=d.PLAY;d.upState()};a.prototype.getLyric=function(b){var c=this;$.ajax({url:b,type:"GET",success:function(g){f(g.trim())},error:function(){c.lyricContainer.html("<div> sorry,暂未提供歌词</div>");c.lyric=null}});function f(k){var h=k.split(/\n/g);var i=/\[\d{2}:\d{2}.\d{2}\]/g;var g=[];var j=e(k);while(!i.test(h[0])){h=h.slice(1)}h[h.length-1].length===0&&h.pop();Array.prototype.forEach.call(h,function(m,n,l){var p=m.match(i),o=m.replace(i,"");Array.prototype.forEach.call(p,function(u,s,q){var r=u.slice(1,-1).split(":");g.push([parseInt(r[0],10)*60+parseFloat(r[1])+j/1000,o])})});g.sort(function(m,l){return m[0]-l[0]});d(g);c.lyric=g}function e(l){var k=0;try{var j=/\[offset:\-?\+?\d+\]/g,h=l.match(j)[0],g=h.split(":")[1];k=parseInt(g)}catch(i){k=0}return k}function d(k){var h=document.createElement("ul");var j="";for(var g=0;g<k.length;g++){j+='\n                <li data-line="'+g+'">'+k[g][1]+"</li>\n                "}c.lyricContainer.html("<ul>"+j+"</ul>")}};a.prototype.upState=function(){switch(this.status){case this.PLAY:MusicVisualizer.play(this.visualizer);this.f_play.children().removeClass("glyphicon-play").addClass("glyphicon-pause");this.speRoll();this.upBg();break;case this.PAUSE:MusicVisualizer.stop(this.visualizer);this.speRoll();this.upBg();this.f_play.children().removeClass("glyphicon-pause").addClass("glyphicon-play");break}if($("#m-list li.current").data("idx")!==this.currentSong){this.listLi.eq(this.currentSong).addClass("current").find("i").text("").addClass("glyphicon glyphicon-music").end().siblings(".current").removeClass("current").find("i").removeClass("glyphicon-music").text(function(){return parseInt($(this).parents("li").data("idx"))+1})}this.listBtn.text(this.allSongData[this.currentSong].song_name)};a.prototype.speRoll=function(){var d=this;var b=100;var c=this.spePre.moved;if(this.status===this.PLAY){this.spePre.timer=setInterval(function(){d.spePre.moved=c++;d.spe.css("transform","rotate("+c+"deg)")},b)}else{if(this.status===this.PAUSE){clearInterval(this.spePre.timer)}}};a.prototype.upBg=function(){var b=this;this.randomImg.inter=30000;if(!this.randomImg.timer){this.randomImg.timer=setInterval(function(){var d=Math.floor(Math.random()*b.theme.count)+1;var c=new Image();c.src="images/bgs/"+b.theme.type+"/bg"+d+".jpg";c.onload=function(){var e="url(images/bgs/"+b.theme.type+"/bg"+d+".jpg)";$(document.body).css("backgroundImage",e)}},b.randomImg.inter)}else{clearInterval(this.randomImg.timer);this.randomImg.timer=null}};a.prototype.getTheme=function(){var d=window.location.hash.slice();var c=/(#type=)([^&]+)(&count=)(\d+)/i;var b=d.match(c);return b};a.prototype.reset=function(){var b=this.getTheme();if(this.theme.type===b[2]){return}else{this.theme.type=b[2];this.theme.count=b[4];$(document.body).css("backgroundImage","url(images/bgs/"+this.theme.type+"/bg1.jpg)");clearInterval(this.randomImg.timer);this.randomImg.timer=null;this.initList()}};return a}());var canvas=$("canvas")[0];var ctx=canvas.getContext("2d");var HEIGHT;var WIDTH;var cw;var ARR=[];ARR.dotMode="random";function getArr(){ARR.length=0;ARR.linearGradient=ctx.createLinearGradient(0,295,0,0);ARR.linearGradient.addColorStop(0,"#5435E8");ARR.linearGradient.addColorStop(0.8,"#8617F4");ARR.linearGradient.addColorStop(1,"#C62F2F");for(var d=0;d<SIZE;d++){var a=random(0,WIDTH),e=random(0,HEIGHT),c="rgba("+random(100,250)+","+random(50,250)+","+random(50,100)+",0)",b=random(1,8)*0.2;ARR.push({x:a,y:e,color:c,dx:ARR.dotMode=="random"?b:0,dx2:b,dy:random(1,5),cap:0,cheight:10})}}function init(){var a=$(window).height();$("#mainc").height(a*2/5).css("top",-a*2/5);HEIGHT=$("#mainc").height();WIDTH=$("#mainc").width();rang=WIDTH>768?64:16;canvas.height=HEIGHT;canvas.width=WIDTH;getArr()}init();Render.type="Column";function random(b,a){b=b||0;a=a||1;return a>=b?Math.round(Math.random()*(a-b)+b):0}function Render(){var a=null;return function(n,f){ctx.fillStyle=ARR.linearGradient;var m=Math.round(WIDTH/rang),o=Math.round(m*0.3);cw=m-o;ctx.clearRect(0,0,WIDTH,HEIGHT);if(Render.type=="Dot"&&((n>3&&f>30)||(f>50&&n>0))){var g=Math.round(n*(f-20)*0.01)+4;for(var c=0;c<g;c++){var j=random(-HEIGHT*2,3*HEIGHT);ctx.beginPath();ctx.moveTo(0,j);ctx.lineTo(WIDTH,HEIGHT-j);ctx.strokeStyle="rgba("+random(100,250)+","+random(50,250)+","+random(50,100)+")";ctx.stroke()}}for(var c=0;c<rang;c++){a=ARR[c];if(Render.type=="Dot"){var l=a.x,j=a.y,b=Math.round((this[c]/2+18)*(HEIGHT>WIDTH?WIDTH:HEIGHT)/600);a.x+=a.dx;a.x>WIDTH&&(a.x=0);ctx.beginPath();ctx.arc(l,j,b,0,Math.PI*2,true);var k=ctx.createRadialGradient(l,j,0,l,j,b);k.addColorStop(0,"rgb(255,255,255)");ctx.fillStyle=k;ctx.fill()}if(Render.type=="Column"){var e=this[c]/280*HEIGHT;ARR[c].cheight>cw&&(ARR[c].cheight=cw);if(--ARR[c].cap<ARR[c].cheight){ARR[c].cap=ARR[c].cheight}if(e>0&&(ARR[c].cap<e+40)){ARR[c].cap=e+40>HEIGHT?HEIGHT:e+40}ctx.fillRect(m*c,HEIGHT-ARR[c].cap,cw,ARR[c].cheight);ctx.fillRect(m*c,HEIGHT-e,cw,e)}}}}var mySwipe=Swipe($("#mySwipe")[0],{});$("#mySwipe").click(function(){mySwipe.next()});var mySwipeH=$("#mySwipe").height();$(window).load(function(){$("body").height($(this).innerHeight());$("#mySwipe").animate({top:$(window).innerHeight()/2-mySwipeH*3/4},1000)}).resize(function(){$("#mySwipe").css("top",$(this).innerHeight()/2-mySwipeH*3/4);$("body").height($(this).innerHeight());init()});var music=new Music("mayday",20);$("#switch .dropdown-menu").delegate("a","click",function(){window.location.hash=$(this).attr("href");music.reset()});